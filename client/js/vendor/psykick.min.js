var Psykick={};!function(){"use strict";function privateRemoveEntities(){for(var i=0,len=entityRemovalQueue.length;len>i;i++){var entity=entityRemovalQueue[i];if("number"==typeof entity){if("undefined"==typeof entities[entity])throw"Invalid entity ID";entity=entity[entity]}null!==entity.Parent&&entity.Parent.removeEntity(entity),delete entities[entity.ID]}entityRemovalQueue=[]}var canvasContainer,gameLoop,nextEntityID=Number.MIN_VALUE,nextLayerID=0,entities={},layers={},layersInDrawOrder=[],entityRemovalQueue=[];Psykick.World=function(options){var self=this,backgroundEl=document.createElement("div"),gameTime=new Date,defaults={canvasContainer:document.getElementById("canvas-container"),width:640,height:480,backgroundColor:"#000",physics:null,onUpdate:function(){}};options=Psykick.Helper.defaults(options,defaults),this.Physics=options.physics,this.PhysicsDrawLayer=null,"string"==typeof options.canvasContainer&&(options.canvasContainer=document.getElementById(options.canvasContainer)),canvasContainer=options.canvasContainer,canvasContainer.style.position="relative",canvasContainer.style.width=options.width+"px",canvasContainer.style.height=options.height+"px",canvasContainer.style.overflow="hidden",backgroundEl.setAttribute("id","psykick-layer-base"),backgroundEl.style.position="absolute",backgroundEl.style.top="0px",backgroundEl.style.left="0px",backgroundEl.style.zIndex=0,backgroundEl.style.width=options.width+"px",backgroundEl.style.height=options.height+"px",backgroundEl.style.backgroundColor=options.backgroundColor,canvasContainer.appendChild(backgroundEl);var requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;gameLoop=function(){var delta=(new Date-gameTime)/1e3;options.onUpdate(delta),self.update(delta),self.draw(),gameTime=new Date,requestAnimationFrame(gameLoop)},requestAnimationFrame(gameLoop)},Psykick.World.prototype.createEntity=function(){var entity=new Psykick.Entity(nextEntityID++);return entities[entity.ID]=entity,entity},Psykick.World.prototype.createLayer=function(){var self=this,layer=new Psykick.Layer({ID:nextLayerID++,container:canvasContainer,world:self});return layers[layer.ID]=layer,layer},Psykick.World.prototype.pushLayer=function(layer){if(!(layer instanceof Psykick.Layer))throw"Invalid argument: 'layer' must be instance of Psykick.Layer";-1===layersInDrawOrder.indexOf(layer)&&(layersInDrawOrder.push(layer),layer.setZIndex(layersInDrawOrder.length),layer.restoreCanvas())},Psykick.World.prototype.popLayer=function(){if(0===layersInDrawOrder.length)return null;var top=layersInDrawOrder[layersInDrawOrder.length-1];return layersInDrawOrder.pop(),top.removeCanvas(),top},Psykick.World.prototype.removeEntity=function(entity){entityRemovalQueue.push(entity)},Psykick.World.prototype.draw=function(){for(var i=0,len=layersInDrawOrder.length;len>i;i++)layersInDrawOrder[i].draw(this.context);null!==this.Physics&&this.Physics.enableDebugDraw&&(null===this.PhysicsDrawLayer&&(this.PhysicsDrawLayer=this.createLayer(),this.Physics.debugDrawContext=this.PhysicsDrawLayer.c,this.pushLayer(this.PhysicsDrawLayer),this.PhysicsDrawLayer.setZIndex(9999999),this.PhysicsDrawLayer.Visible=!1),this.Physics.draw())},Psykick.World.prototype.update=function(delta){privateRemoveEntities();for(var i=0,len=layersInDrawOrder.length;len>i;i++)layersInDrawOrder[i].update(delta);null!==this.Physics&&this.Physics.update(delta)},Psykick.World.prototype.getLayer=function(layerID){return layers.hasOwnProperty(layerID)?layers[layerID]:null},Psykick.World.prototype.getEntity=function(entityID){return entities.hasOwnProperty(entityID)?entities[entityID]:null}}(),Psykick.Keys={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Shift:16,Ctrl:17,Alt:18,CapsLock:20,NumLock:144,Zero:48,One:49,Two:50,Three:51,Four:52,Five:53,Six:54,Seven:55,Eight:56,Nine:57,Left:37,Up:38,Right:39,Down:40,Space:32,Enter:13,Tab:9,Esc:27,Backspace:8},Psykick.Helper={},function(undefined){"use strict";var breaker={},ArrayProto=Array.prototype,ObjProto=Object.prototype,slice=(Function.prototype,ArrayProto.push,ArrayProto.slice),hasOwnProperty=(ArrayProto.concat,ObjProto.hasOwnProperty),nativeForEach=ArrayProto.forEach,keysDown={};window.onkeydown=function(e){keysDown[e.keyCode]={pressed:!0,shift:e.shiftKey,ctrl:e.ctrlKey,alt:e.altKey}},window.onkeyup=function(e){keysDown.hasOwnProperty(e.keyCode)&&(keysDown[e.keyCode].pressed=!1)},Psykick.Helper.has=function(obj,key){return hasOwnProperty.call(obj,key)},Psykick.Helper.forEach=function(obj,iterator,context){if(null!==obj&&obj!==undefined)if(nativeForEach&&obj.forEach===nativeForEach)obj.forEach(iterator,context);else if(obj.length===+obj.length){for(var i=0,len=obj.length;len>i;i++)if(iterator.call(context,obj[i],i,obj)===breaker)return}else for(var key in obj)if(Helper.has(obj,key)&&iterator.call(context,obj[key],key,obj)===breaker)return},Psykick.Helper.defaults=function(obj){return obj=obj||{},Psykick.Helper.forEach(slice.call(arguments,1),function(source){if(source)for(var prop in source)void 0===obj[prop]&&(obj[prop]=source[prop])}),obj},Psykick.Helper.extend=function(Derived,Base){Derived.prototype=new Base,Derived.constructor=Derived},Psykick.Helper.isKeyDown=function(keyCode,modifiers){modifiers=modifiers||{};var defaultModifiers={shift:!1,ctrl:!1,alt:!1};return modifiers=Psykick.Helper.defaults(modifiers,defaultModifiers),!(!keysDown.hasOwnProperty(keyCode)||!keysDown[keyCode].pressed||modifiers.shift&&!keysDown[keyCode].shift||modifiers.ctrl&&!keysDown[keyCode].ctrl||modifiers.alt&&!keysDown[keyCode].alt)},Psykick.Helper.getKeysDown=function(){var keys=[];for(var keyCode in keysDown)keysDown.hasOwnProperty(keyCode)&&keysDown[keyCode].pressed&&keys.push(keyCode);return keys}}(),Psykick.Components={},Psykick.Component=function(){this.Name="Component"},function(){"use strict";Psykick.Entity=function(id){this.ID=id,this.Components={},this.Parent=null},Psykick.Entity.prototype.setParentLayer=function(layer){if(!(layer instanceof Psykick.Layer))throw"Invalid Argument: 'layer' must be an instance of Psykick.Layer";this.Parent=layer},Psykick.Entity.prototype.addComponent=function(component){component instanceof Psykick.Component&&(this.Components[component.Name]=component)},Psykick.Entity.prototype.removeComponent=function(componentName){componentName instanceof Psykick.Component&&(componentName=componentName.Name),delete this.Components[componentName]},Psykick.Entity.prototype.getComponent=function(componentName){return componentName in this.Components?this.Components[componentName]:null},Psykick.Entity.prototype.hasComponent=function(componentName){return null!==this.getComponent(componentName)}}(),Psykick.Layer=function(options){this.ID=options.ID,this.container=options.container,this.World=options.world,this.Entities={},this.RenderSystems=[],this.BehaviorSystems=[],this.Visible=!0,this.Active=!0;var canvas=document.createElement("canvas");canvas.width=parseInt(options.container.style.width,10),canvas.height=parseInt(options.container.style.height,10),canvas.setAttribute("id","psykick-layer-"+options.ID),canvas.style.position="absolute",canvas.style.top="0px",canvas.style.left="0px",canvas.style.zIndex=0,this.c=canvas.getContext("2d")},Psykick.Layer.prototype.removeCanvas=function(){this.c.canvas.parentNode.removeChild(this.c.canvas)},Psykick.Layer.prototype.restoreCanvas=function(){null===document.getElementById("psykick-layer-"+this.ID)&&this.container.appendChild(this.c.canvas)},Psykick.Layer.prototype.setZIndex=function(zIndex){this.c.canvas.style.zIndex=zIndex},Psykick.Layer.prototype.addEntity=function(entity,addToSystems){if(addToSystems=addToSystems||!1,entity.setParentLayer(this),this.Entities[entity.ID]=entity,addToSystems)for(var bLen=this.BehaviorSystems.length,rLen=this.RenderSystems.length,i=0;bLen>i||rLen>i;i++)bLen>i&&this.BehaviorSystems[i].addEntity(entity),rLen>i&&this.RenderSystems[i].addEntity(entity)},Psykick.Layer.prototype.removeEntity=function(entityID){entityID instanceof Psykick.Entity&&(entityID=entityID.ID);for(var i=0,bLen=this.BehaviorSystems.length,rLen=this.RenderSystems.length;bLen>i||rLen>i;i++)bLen>i&&this.BehaviorSystems[i].removeEntity(entityID),rLen>i&&this.RenderSystems[i].removeEntity(entityID);delete this.Entities[entityID]},Psykick.Layer.prototype.addSystem=function(system){if(!(system instanceof Psykick.System))throw"Invalid argument: 'system' must be an instance of Psykick.System";system.setParentLayer(this),system instanceof Psykick.BehaviorSystem&&-1===this.BehaviorSystems.indexOf(system)?this.BehaviorSystems.push(system):system instanceof Psykick.RenderSystem&&-1===this.RenderSystems.indexOf(system)&&this.RenderSystems.push(system)},Psykick.Layer.prototype.getEntities=function(){return this.Entities},Psykick.Layer.prototype.getEntitiesByComponents=function(components){var numOfComponents=components.length,entities=[];for(var id in this.Entities)if(this.Entities.hasOwnProperty(id)){for(var entity=this.Entities[id],hasComponents=!0,i=0;numOfComponents>i;i++)if(!entity.hasComponent(components[i])){hasComponents=!1;break}hasComponents&&entities.push(entity)}return entities},Psykick.Layer.prototype.draw=function(){if(null!==this.c.canvas.parentNode&&(this.c.clearRect(0,0,this.c.canvas.width,this.c.canvas.height),this.Visible&&this.RenderSystems.length>0)){this.c.save();for(var i=0,len=this.RenderSystems.length;len>i;i++){var system=this.RenderSystems[i];system.Active&&system.draw(this.c)}this.c.restore()}},Psykick.Layer.prototype.update=function(delta){if(this.Active&&this.BehaviorSystems.length>0)for(var i=0,len=this.BehaviorSystems.length;len>i;i++){var system=this.BehaviorSystems[i];system.Active&&system.update(delta)}},Psykick.Systems={},function(){"use strict";Psykick.System=function(){this.Entities={},this.Parent=null,this.RequiredComponents=[],this.Active=!0},Psykick.System.prototype.setParentLayer=function(layer){if(!(layer instanceof Psykick.Layer))throw"Invalid argument: 'layer' must be an instance of Psykick.Layer";this.Parent=layer},Psykick.System.prototype.addEntity=function(entity){if(entity instanceof Psykick.Entity){for(var i=0,len=this.RequiredComponents.length;len>i;i++)if(!(this.RequiredComponents[i]in entity.Components))return!1;return this.Entities[entity.ID]=entity,!0}throw"Invalid Argument: 'entity' must be an instance of Psykick.Entity"},Psykick.System.prototype.removeEntity=function(entity){var entityID=entity;return entity instanceof Psykick.Entity&&(entityID=entity.ID),this.Entities.hasOwnProperty(entityID)?(delete this.Entities[entityID],!0):!1}}(),function(){"use strict";Psykick.BehaviorSystem=function(){Psykick.System.call(this),this.ActionOrder=[]},Psykick.BehaviorSystem.prototype=new Psykick.System,Psykick.BehaviorSystem.constructor=Psykick.BehaviorSystem,Psykick.BehaviorSystem.prototype.addEntity=function(entity){Psykick.System.prototype.addEntity.call(this,entity)&&-1===this.ActionOrder.indexOf(entity)&&this.ActionOrder.push(entity)},Psykick.BehaviorSystem.prototype.removeEntity=function(entity){if(Psykick.System.prototype.removeEntity.call(this,entity)){if(entity instanceof Psykick.Entity){var index=this.ActionOrder.indexOf(entity);-1!==index&&this.ActionOrder.splice(index,1)}else for(var i=0,len=this.ActionOrder.length;len>i;i++)if(this.ActionOrder[i].ID===entity){this.ActionOrder.splice(i,1);break}return!0}return!1},Psykick.BehaviorSystem.prototype.update=function(){}}(),function(){"use strict";Psykick.RenderSystem=function(){Psykick.System.call(this),this.DrawOrder=[]},Psykick.RenderSystem.prototype=new Psykick.System,Psykick.RenderSystem.constructor=Psykick.RenderSystem,Psykick.RenderSystem.prototype.addEntity=function(entity){Psykick.System.prototype.addEntity.call(this,entity)&&-1===this.DrawOrder.indexOf(entity)&&this.DrawOrder.push(entity)},Psykick.RenderSystem.prototype.removeEntity=function(entity){if(Psykick.System.prototype.removeEntity.call(this,entity)){if(entity instanceof Psykick.Entity){var index=this.DrawOrder.indexOf(entity);-1!==index&&this.DrawOrder.splice(index,1)}else for(var i=0,len=this.DrawOrder.length;len>i;i++)if(this.DrawOrder[i].ID===entity){this.DrawOrder.splice(i,1);break}return!0}return!1},Psykick.RenderSystem.prototype.draw=function(){}}(),function(){var b2Vec2=Box2D.Common.Math.b2Vec2,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2World=(Box2D.Dynamics.b2Fixture,Box2D.Dynamics.b2World),b2PolygonShape=(Box2D.Collision.Shapes.b2MassData,Box2D.Collision.Shapes.b2PolygonShape),b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw;Psykick.Physics=function(options){var defaults={gravity:{x:0,y:9.8},ignoreInactiveBodies:!0,scale:30,fps:40,velocityIterations:8,positionIterations:3,enableDebugDraw:!1,debugDrawContext:null};options=Psykick.Helper.defaults(options,defaults);var gravity=new b2Vec2(options.gravity.x,options.gravity.y);this.World=new b2World(gravity,options.ignoreInactiveBodies),this.scale=options.scale,this.fps=options.fps,this.velocityIterations=options.velocityIterations,this.positionIterations=options.positionIterations,this.enableDebugDraw=options.enableDebugDraw,this.debugDraw=null,this.debugDrawContext=options.debugDrawContext,this.deltaRemaining=0,this.bodyRemovalQueue=[],this.enableDebugDraw&&(this.debugDraw=new b2DebugDraw,this.debugDraw.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit))},Psykick.Physics.prototype.update=function(delta){var bodiesToRemove=this.bodyRemovalQueue.length,stepAmount=1/this.fps;if(bodiesToRemove>0)for(var i=0;bodiesToRemove>i;i++)this.World.RemoveBody(this.bodyRemovalQueue[i]);for(this.deltaRemaining+=delta;this.deltaRemaining>stepAmount;)this.deltaRemaining-=stepAmount,this.World.Step(stepAmount,this.velocityIterations,this.positionIterations)},Psykick.Physics.prototype.draw=function(){this.enableDebugDraw&&null!==this.debugDrawContext&&(null===this.debugDraw&&(this.debugDraw=new b2DebugDraw,this.debugDraw.SetFillAlpha(.3),this.debugDraw.SetLineThickness(1),this.debugDraw.SetFlags(b2DebugDraw.e_shapeBit|b2DebugDraw.e_jointBit)),this.debugDraw.SetSprite(this.debugDrawContext),this.debugDraw.SetDrawScale(this.scale),this.World.SetDebugDraw(this.debugDraw),this.World.DrawDebugData())},Psykick.Physics.prototype.createBody=function(options){var key,defaults={shape:"block",width:10,height:10,radius:5,type:"dynamic",position:{x:0,y:0},velocity:{x:0,y:0}},fixtureDefaults={density:2,friction:1,restitution:.2,points:[]},definitionDefaults={active:!0,allowSleep:!0,angle:0,angularVelocity:0,awake:!0,bullet:!1,fixedRotation:!1},newBody={};options=Psykick.Helper.defaults(options,defaults),options.fixture=Psykick.Helper.defaults(options.fixture,fixtureDefaults),options.definition=Psykick.Helper.defaults(options.definition,definitionDefaults),newBody.definition=new b2BodyDef;for(key in definitionDefaults)newBody.definition[key]=options.definition[key]||definitionDefaults[key];newBody.definition.position=new b2Vec2(options.position.x/this.scale,options.position.y/this.scale),newBody.definition.linearVelocity=new b2Vec2(options.velocity.x,options.velocity.y),newBody.definition.userData=newBody,newBody.definition.type="static"===options.type?b2Body.b2_staticBody:"dynamic"===options.type?b2Body.b2_dynamicBody:b2Body.b2_kinematicBody,newBody.body=this.World.CreateBody(newBody.definition),newBody.fixtureDef=new b2FixtureDef;for(key in fixtureDefaults)newBody.fixtureDef[key]=options.fixture[key]||fixtureDefaults[key];switch(options.shape){case"circle":newBody.fixtureDef.shape=new b2CircleShape(options.radius/this.scale);break;case"polygon":for(var i=0,len=options.points.length;len>i;i++){var point=options.points[i];point.x/=this.scale,point.y/=this.scale,options.points[i]=point}newBody.fixtureDef.shape=new b2PolygonShape,newBody.fixtureDef.shape.SetAsArray(options.points,options.points.length);break;case"block":default:newBody.fixtureDef.shape=new b2PolygonShape,newBody.fixtureDef.shape.SetAsBox(options.width/2/this.scale,options.height/2/this.scale)}return newBody.body.CreateFixture(newBody.fixtureDef),newBody},Psykick.Physics.prototype.removeBody=function(body){-1===this.bodyRemovalQueue.indexOf(body)&&this.bodyRemovalQueue.push(body)}}(),function(){Psykick.Components.Animation=function(options){this.Name="Animation";var defaults={fps:24,minFrame:0,maxFrame:0,currentFrame:0,lastFrameTime:0};options=Psykick.Helper.defaults(options,defaults),this.fps=options.fps,this.minFrame=options.minFrame,this.maxFrame=options.maxFrame,this.currentFrame=options.currentFrame,this.lastFrameTime=options.lastFrameTime},Psykick.Helper.extend(Psykick.Components.Animation,Psykick.Component),Psykick.Components.Animation.prototype.getFrame=function(delta){return this.lastFrameTime+=delta,this.lastFrameTime>1e3/this.fps&&(this.lastFrameTime=0,++this.currentFrame>this.maxFrame&&this.maxFrame>-1&&(this.currentFrame=this.minFrame)),this.currentFrame}}(),Psykick.Components.Color=function(options){this.Name="Color";var defaults={colors:[]};options=Psykick.Helper.defaults(options,defaults),this.colors=options.colors},Psykick.Helper.extend(Psykick.Components.Color,Psykick.Component),function(){"use strict";Psykick.Components.SpriteSheet=function(options){this.Name="SpriteSheet";var self=this,defaults={src:null,width:0,height:0,frameWidth:0,frameHeight:0,xOffset:0,yOffset:0};options=Psykick.Helper.defaults(options,defaults),this.img=new Image,this.img.src=options.src,this.img.width=options.width,this.img.height=options.height,this.frameWidth=options.frameWidth,this.frameHeight=options.frameHeight,this.xOffset=options.xOffset,this.yOffset=options.yOffset,this.loaded=!1,this.img.onload=function(){self.loaded=!0}},Psykick.Helper.extend(Psykick.Components.SpriteSheet,Psykick.Component),Psykick.Components.SpriteSheet.prototype.getWidth=function(){return this.img.width},Psykick.Components.SpriteSheet.prototype.getHeight=function(){return this.img.height},Psykick.Components.SpriteSheet.prototype.setWidth=function(width){this.img.width=width},Psykick.Components.SpriteSheet.prototype.setHeight=function(height){this.img.height=height},Psykick.Components.SpriteSheet.prototype.changeImage=function(path){this.img.src=path},Psykick.Components.SpriteSheet.prototype.getOffset=function(frameX,frameY){if(null===this.img.src)return null;frameX=frameX||0,frameY=frameY||0;var offsetX=this.frameWidth*frameX+this.xOffset,offsetY=this.frameHeight*frameY+this.yOffset;return offsetX>this.img.width||offsetY>this.img.height?null:{x:offsetX,y:offsetY}}}(),Psykick.Components.Circle=function(options){this.Name="Circle";var defaults={x:0,y:0,r:0};options=Psykick.Helper.defaults(options,defaults),this.x=options.x,this.y=options.y,this.r=options.r},Psykick.Helper.extend(Psykick.Components.Circle,Psykick.Component),Psykick.Components.Point=function(options){this.Name="Point";var defaults={x:0,y:0};options=Psykick.Helper.defaults(options,defaults),this.x=options.x,this.y=options.y},Psykick.Helper.extend(Psykick.Components.Point,Psykick.Component),Psykick.Components.Position=function(coords){this.Name="Position";var defaults={x:0,y:0,rotation:0};coords=Psykick.Helper.defaults(coords,defaults),this.x=coords.x,this.y=coords.y,this.rotation=coords.rotation},Psykick.Helper.extend(Psykick.Components.Position,Psykick.Component),Psykick.Components.Rectangle=function(options){this.Name="Rectangle";var defaults={x:0,y:0,w:0,h:0};options=Psykick.Helper.defaults(options,defaults),this.x=options.x,this.y=options.y,this.w=options.w,this.h=options.h},Psykick.Helper.extend(Psykick.Components.Rectangle,Psykick.Component),Psykick.Systems.Sprite=function(){Psykick.RenderSystem.call(this),this.RequiredComponents=["SpriteSheet","Position"]},Psykick.Systems.Sprite.prototype=new Psykick.RenderSystem,Psykick.Systems.Sprite.constructor=Psykick.Systems.Sprite,Psykick.Systems.Sprite.prototype.draw=function(c){for(var i=0,len=this.DrawOrder.length;len>i;i++){var entity=this.DrawOrder[i],spriteSheet=entity.getComponent("SpriteSheet"),position=entity.getComponent("Position");c.save(),c.translate(position.x,position.y),c.rotate(position.rotation),c.drawImage(spriteSheet.img,spriteSheet.xOffset,spriteSheet.yOffset,spriteSheet.frameWidth,spriteSheet.frameHeight,-spriteSheet.frameWidth/2,-spriteSheet.frameHeight/2,spriteSheet.frameWidth,spriteSheet.frameHeight),c.restore()}};